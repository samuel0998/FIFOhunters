<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Dashboard FIFO</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<div class="top">
    <h1>DASHBOARD FIFO</h1>
    <a href="/scan" class="btn-upload">Scanner</a>
</div>

<!-- ===================== CARDS DE STATUS ===================== -->

<div class="dashboard-cards">

    <div class="dash-card ok" onclick="filterStatus('OK')">
        <h3>OK</h3>
        <span id="okCount">0</span>
    </div>

    <div class="dash-card atencao" onclick="filterStatus('ATENCAO')">
        <h3>ATENÇÃO</h3>
        <span id="warnCount">0</span>
    </div>

    <div class="dash-card critico" onclick="filterStatus('CRITICO')">
        <h3>CRÍTICO</h3>
        <span id="critCount">0</span>
    </div>

</div>

<!-- ===================== CONES ===================== -->

<h2 class="section-title">Distribuição por Cones</h2>

<div id="coneGrid" class="cone-grid"></div>

<!-- ===================== GRÁFICO ===================== -->

<h2 class="section-title">Gráfico de Criticidade</h2>

<div class="chart-container">
    <canvas id="statusChart"></canvas>
</div>

<!-- ===================== SCRIPT ===================== -->

<script>

let chartInstance = null;

async function loadDashboard() {

    const res = await fetch("/api/dashboard/full");
    const data = await res.json();

    document.getElementById("okCount").innerText = data.OK;
    document.getElementById("warnCount").innerText = data.ATENCAO;
    document.getElementById("critCount").innerText = data.CRITICO;

    renderCones(data.cones);
    createChart(data);
}

function createChart(data) {

    if (chartInstance) {
        chartInstance.destroy();
    }

    const ctx = document.getElementById("statusChart").getContext("2d");

    chartInstance = new Chart(ctx, {
        type: "doughnut",
        data: {
            labels: ["OK", "ATENÇÃO", "CRÍTICO"],
            datasets: [{
                data: [data.OK, data.ATENCAO, data.CRITICO],
                backgroundColor: ["#22c55e", "#facc15", "#ef4444"]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
        }
    });
}

function renderCones(cones) {

    const grid = document.getElementById("coneGrid");
    grid.innerHTML = "";

    const coneColors = {
        "Domingo": "black",
        "Segunda": "blue",
        "Terça": "yellow",
        "Quarta": "green",
        "Quinta": "orange",
        "Sexta": "white",
        "Sábado": "pink"
    };

    for (const dia in cones) {

        const div = document.createElement("div");
        div.className = "cone-card";

        div.onclick = () => filterCone(dia);

        div.innerHTML = `
            <div class="cone-header">
                <div class="cone-circle" style="background:${coneColors[dia]}"></div>
                <span>${dia}</span>
            </div>
            <div class="cone-count">${cones[dia]}</div>
        `;

        grid.appendChild(div);
    }
}

function filterStatus(status) {
    window.location.href = `/scan?status=${status}`;
}

function filterCone(dia) {
    window.location.href = `/scan?cone=${dia}`;
}

loadDashboard();

</script>

</body>
</html>
